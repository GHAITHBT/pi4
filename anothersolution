# Maintain a list of materials to activate LEDs one by one
material_order = []  # This will be populated with the order of materials
current_material_index = 0  # Track the index of the current material being confirmed

# Initialize GPIO based on the configuration
def initialize_gpio(config):
    global material_order, current_material_index
    material_order = list(led_pins.keys())  # Ensure materials are ordered
    current_material_index = 0  # Start with the first material

    GPIO.setmode(GPIO.BCM)
    GPIO.setwarnings(False)

    # Setup LED pins
    for pin in led_pins.values():
        GPIO.setup(pin, GPIO.OUT)
        GPIO.output(pin, GPIO.LOW)

    # Setup button pins
    for pin in button_pins.values():
        GPIO.setup(pin, GPIO.IN, pull_up_down=GPIO.PUD_UP)

    # Setup status LED pin
    GPIO.setup(status_led_pin, GPIO.OUT)
    GPIO.output(status_led_pin, GPIO.HIGH)

    # Light up the first LED
    if material_order:
        first_material = material_order[current_material_index]
        GPIO.output(led_pins[first_material], GPIO.HIGH)


# Button callback when pressed (for confirming material pick)
def button_callback(channel):
    global current_material_index

    if current_material_index < len(material_order):
        material = material_order[current_material_index]
        if button_pins.get(material) == channel:
            GPIO.output(led_pins[material], GPIO.LOW)  # Turn off current LED

            try:
                # Send confirmation to the server
                response = requests.post(f'http://10.110.10.204:5001/confirmation_material', 
                                         json={'material': material, 'hostname': hostname})
                response.raise_for_status()
                print(f"Material {material} confirmed.")
            except requests.RequestException as e:
                print(f"Error sending confirmation: {e}")
                return

            # Move to the next material (next LED)
            current_material_index += 1
            if current_material_index < len(material_order):
                next_material = material_order[current_material_index]
                GPIO.output(led_pins[next_material], GPIO.HIGH)  # Turn on the next LED
            else:
                print("All materials confirmed.")
